"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),RequestBundler=function(){function t(e){_classCallCheck(this,t),this.data=[],this.pending=[],this.requestHandler=e}return _createClass(t,[{key:"get",value:function(t,e){var i=this,n=this.data.filter(function(e){return e.url===t}),s=this.pending.filter(function(e){return e.url===t});n&&n.length?e(n[0]):s&&s.length?s[0].callbacks.push(e):this.pending.push({url:t,request:this.requestHandler(t).then(function(e){return i._handleCallbacks(t,e)}),callbacks:[e]})}},{key:"_handleCallbacks",value:function(t,e){var i=this.data.filter(function(e){return e.url===t});i&&(i=e);var n=this.pending.filter(function(e){return e.url===t});n&&(n[0].callbacks.forEach(function(t){return t(e)}),this.pending=this.pending.filter(function(e){return e.url!==t}))}}]),t}();!function(t){var e=function(){function e(i,n){var s=this;_classCallCheck(this,e),this.autoSelect=!0,this.$input=t(i),this.$input.addClass("form-control");var o="autocomplete input-group";this.$input.hasClass("input-sm")&&(o+=" input-group-sm"),this.$input.wrap('<div class="'+o+'"></div>'),this.$container=this.$input.parent(".autocomplete"),this.$container.append('<span class="input-group-btn"><button class="btn btn-default" type="button" tabindex="-1"></button></span>'),this.$container.append('<ul class="items dropdown-menu" style="display:none;"></ul>'),this.$button=this.$container.find("button"),this.$items=this.$container.find(".items"),this.$input.attr("disabled")&&this.$button.attr("disabled","disabled"),this.parseOptions(n);var a=this;this._filterOnHandler=function(){a.search(this.value)}.bind(this.$input[0]),this._validateOnHandler=function(){a.open=!1,a.options.validation&&(!a.options.validation(a.$input.val(),a.data)&&a.options.invalidClass?a.$input.addClass(a.options.invalidClass):a.$input.removeClass(a.options.invalidClass))}.bind(this.$input[0]),this._onFocusHandler=function(){a.open=!0}.bind(this.$input[0]),this._buttonClickHandler=function(){a.toggleOpen()},this._globalKeyEventHandler=function(t){27===t.keyCode&&(a.open=!1)},this.initializeEventHandlers(),t("body").click(function(){var e=t(document.activeElement);e.is(s.$input)||e.is(s.$button)||e.is(s.$items)||s.$items.find(e).length||(s.open=!1)}),this.setButtonIcon(),this.loadDataSource()}return _createClass(e,[{key:"reinitialize",value:function(t){this.open&&(this.open=!1),this.removeEventHandlers(),this.parseOptions(t),this.initializeEventHandlers(),this.loadDataSource()}},{key:"parseOptions",value:function(e){if(this.options=t.extend({},this.options,e),this.options.validation&&(this.options.validation=this.options.validation.bind(this)),this.options.filter&&(this.options.filter=this.options.filter.bind(this)),this.$input.data("value-field")?this.$valueField=t(this.$input.data("value-field")):"string"==typeof this.options.valueField?this.$valueField=t(this.options.valueField):this.options.valueField&&this.options.valueField.length&&(this.$valueField=this.options.valueField),this.$input.data("appendToBody")&&(this.options.appendToBody=!!this.$input.data("appendToBody")),this.options.appendToBody){var i=""+1e4*Math.random()*(new Date).getTime()*window.outerHeight;this.$items.attr("id",i),this.$container.attr("dd-menu",i),this.$items.detach().appendTo("body")}}},{key:"initializeEventHandlers",value:function(){this.$input[0].addEventListener(this.options.onFocus,this._onFocusHandler),this.$input[0].addEventListener(this.options.filterOn,this._filterOnHandler),this.$input[0].addEventListener(this.options.validateOn,this._validateOnHandler),this.$button[0].addEventListener("click",this._buttonClickHandler),window.addEventListener("keydown",this._globalKeyEventHandler)}},{key:"removeEventHandlers",value:function(){this.$input[0].removeEventListener(this.options.onFocus,this._onFocusHandler),this.$input[0].removeEventListener(this.options.filterOn,this._filterOnHandler),this.$input[0].removeEventListener(this.options.validateOn,this._validateOnHandler),this.$button[0].removeEventListener("click",this._buttonClickHandler),window.removeEventListener("keydown",this._globalKeyEventHandler)}},{key:"setButtonIcon",value:function(){this.$button.html('<span class="'+(this.open?"fa fa-caret-up":"fa fa-caret-down")+'"></span>')}},{key:"search",value:function(t){t||(t=""),this.selected=null;var e=void 0;return e=this.options.filter?this.options.filter(t,this.data):this.data,this.buildDropdownItems(e),e&&e.length&&t&&(1===e.length?this.autoSelect&&(this.selected=e[0],this.$input.val(e[0][this.options.nameProperty]),this.autoSelect=!1):this.autoSelect=!0),e}},{key:"buildDropdownItems",value:function(t){if(t&&t.length){var e=this;this.destroyDropdownItems(),t.forEach(function(t){var i=document.createElement("li");i.setAttribute("value",t[e.options.valueProperty]),i.innerHTML="<a>"+t[e.options.nameProperty]+"</a>",i.addEventListener("click",function(i){e.$input.val(t[e.options.nameProperty]),e.selected=t,e.open=!1}),e.$items.append(i)})}}},{key:"destroyDropdownItems",value:function(){this.$items.children().remove()}},{key:"toggleOpen",value:function(){this.open=!this.open}},{key:"loadDataSource",value:function(){if(this.data=[],this.datasource=this.$input.data("source"),this.datasource||(this.datasource=this.options.dataSource),this.datasource)if("string"==typeof this.datasource){var t=this;n.get(this.datasource,function(e){t.data=e,t.selectInitialValue()})}else"object"===_typeof(this.datasource)&&(this.data=this.datasource,this.selectInitialValue())}},{key:"selectInitialValue",value:function(){this.$valueField&&(this.selected=this.$valueField.val(),this.$input.val(this.selected[this.options.nameProperty])),this.$input.trigger(this.options.initialValueSelectedEvent)}},{key:"setMenuDirection",value:function(){var e=this.$input.offset(),i=this.$input.outerHeight(),n=parseInt(this.$input.css("margin-top")),s=this.$items.outerHeight(),o=t(window).height(),a=e.top+i+s>o,l=e.top-t(window).scrollTop()-s>0;a&&l?this.$items.offset({top:e.top-s-n,left:e.left}):this.$items.offset({top:e.top+i+n,left:e.left})}},{key:"open",get:function(){return!!this.$container.attr("open")},set:function(t){t?this.$container.attr("open",""):this.$container.removeAttr("open"),this.setButtonIcon(),this.open?(this.buildDropdownItems(this.data),this.$items.show(),this.setMenuDirection()):(this.$items.hide(),this.destroyDropdownItems())}},{key:"selected",get:function(){return this.$container.data("selected")},set:function(t){var e=this;if(t||(t={}),"object"!==(void 0===t?"undefined":_typeof(t))&&this.data){isNaN(+t)||(t=+t);var i=this.data.filter(function(i){return i[e.options.valueProperty]===t});i&&i.length&&i[0]&&(t=i[0])}this.$container[0].setAttribute("selected",t[this.options.valueProperty]||""),this.$container.data("selected",t),this.$valueField&&this.$valueField.val(t[this.options.valueProperty]||""),this.options.onSelected&&this.options.onSelected(this),this.$input.trigger("change")}}]),e}(),i={nameProperty:"name",valueProperty:"value",valueField:null,dataSource:null,filter:function(t,e){var i=this;return e.filter(function(e){return~e[i.options.nameProperty].toLowerCase().indexOf(t.toLowerCase())})},filterOn:"input",onFocus:"click",validation:null,validateOn:"blur",onSelected:null,invalidClass:"invalid",initialValueSelectedEvent:"initial-value-selected.autocomplete",appendToBody:!1},n=new RequestBundler(t.get);t.fn.autocomplete=function(n){return this.each(function(){var s=t(this),o=s.data("autocomplete"),a="object"===(void 0===n?"undefined":_typeof(n))&&n;if(o)o.reinitialize(a);else{var l=t.extend({},i,a),r=new e(this,l);s.data("autocomplete",r)}}),this},t(function(){t('[data-provide="softec-autocomplete"]').autocomplete()})}(window.jQuery);