"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),RequestBundler=function(){function t(e){_classCallCheck(this,t),this.data=[],this.pending=[],this.requestHandler=e}return _createClass(t,[{key:"get",value:function(t,e){var i=this,n=this.data.filter(function(e){return e.url===t}),s=this.pending.filter(function(e){return e.url===t});n&&n.length?e(n[0]):s&&s.length?s[0].callbacks.push(e):this.pending.push({url:t,request:this.requestHandler(t).then(function(e){return i._handleCallbacks(t,e)}),callbacks:[e]})}},{key:"_handleCallbacks",value:function(t,e){var i=this.data.filter(function(e){return e.url===t});i&&(i=e);var n=this.pending.filter(function(e){return e.url===t});n&&(n[0].callbacks.forEach(function(t){return t(e)}),this.pending=this.pending.filter(function(e){return e.url!==t}))}}]),t}();!function($){var Autocomplete=function(){function Autocomplete(t,e){var i=this;_classCallCheck(this,Autocomplete),this.autoSelect=!0,this.$input=$(t),this.$input.addClass("form-control");var n="autocomplete input-group";this.$input.hasClass("input-sm")&&(n+=" input-group-sm"),this.$input.wrap('<div class="'+n+'"></div>'),this.$container=this.$input.parent(".autocomplete"),this.$container.append('<span class="input-group-btn"><button class="btn btn-default" type="button" tabindex="-1"></button></span>'),this.$container.append('<ul class="items dropdown-menu" style="display:none;"></ul>'),this.$button=this.$container.find("button"),this.$items=this.$container.find(".items"),this.$input.attr("disabled")&&this.$button.attr("disabled","disabled"),this.parseOptions(e);var s=this;this._filterOnHandler=function(){s.search(this.value)}.bind(this.$input[0]),this._onKeyDown=function(t){9==(t.keyCode||t.which)&&(s.open=!1)}.bind(this.$input[0]),this._validateOnHandler=function(){s.options.validation&&(!s.options.validation(s.$input.val(),s.data)&&s.options.invalidClass?s.$input.addClass(s.options.invalidClass):s.$input.removeClass(s.options.invalidClass))}.bind(this.$input[0]),this._openOnInputHandler=function(){s.open=!0}.bind(this.$input[0]),this._buttonClickHandler=function(){s.toggleOpen()},this._globalKeyEventHandler=function(t){27===t.keyCode&&(s.open=!1)},this._onBlurHandler=function(){s.autoSelect=!0},this.initializeEventHandlers(),$("body").click(function(){var t=$(document.activeElement);t.is(i.$input)||t.is(i.$button)||t.is(i.$items)||i.$items.find(t).length||(i.open=!1)}),this.setButtonIcon(),this.loadDataSource()}return _createClass(Autocomplete,[{key:"reinitialize",value:function(t){this.open&&(this.open=!1),this.removeEventHandlers(),this.parseOptions(t),this.initializeEventHandlers(),this.loadDataSource()}},{key:"parseOptions",value:function parseOptions(options){if(this.options=$.extend({},this.options,options),this.options.filter&&(this.options.filter=this.options.filter.bind(this)),this.$input.data("value-field")?this.$valueField=$(this.$input.data("value-field")):"string"==typeof this.options.valueField?this.$valueField=$(this.options.valueField):this.options.valueField&&this.options.valueField.length&&(this.$valueField=this.options.valueField),this.$input.data("append-to-body")&&(this.options.appendToBody=!!this.$input.data("append-to-body")),this.options.appendToBody){var id=""+1e4*Math.random()*(new Date).getTime()*window.outerHeight;this.$items.attr("id",id),this.$container.attr("dd-menu",id),this.$items.detach().appendTo("body")}var attr=this.$input.attr("open-on-input");this.options.openOnInput="false"!=attr;var attr=this.$input.attr("select-first");this.options.selectFirstMatch="true"==attr;var preAppendDataItem=this.$input.attr("pre-append");preAppendDataItem&&(this.options.preAppendDataItem=new Function("li","item",preAppendDataItem)),this.options.preAppendDataItem&&(this.options.preAppendDataItem=this.options.preAppendDataItem.bind(this));var validation=this.$input.attr("validation");validation&&(this.options.validation=function(input,data){return eval(validation)});var invalidClassAttr=this.$input.data("invalid-class");invalidClassAttr&&(this.options.invalidClass=invalidClassAttr),this.options.validation&&(this.options.validation=this.options.validation.bind(this));var distinctAttr=this.$input.attr("distinct");"true"===distinctAttr&&(this.options.distinct=!0)}},{key:"initializeEventHandlers",value:function(){this.options.openOnInput&&this.$input[0].addEventListener("input",this._openOnInputHandler),this.$input[0].addEventListener("keydown",this._onKeyDown),this.$input[0].addEventListener("blur",this._onBlurHandler),this.$input[0].addEventListener(this.options.filterOn,this._filterOnHandler),this.$input[0].addEventListener(this.options.validateOn,this._validateOnHandler),this.$button[0].addEventListener("click",this._buttonClickHandler),window.addEventListener("keydown",this._globalKeyEventHandler)}},{key:"removeEventHandlers",value:function(){this.options.openOnInput&&this.$input[0].removeEventListener("input",this._openOnInputHandler),this.$input[0].removeEventListener("keydown",this._onKeyDown),this.$input[0].removeEventListener(this.options.filterOn,this._filterOnHandler),this.$input[0].removeEventListener(this.options.validateOn,this._validateOnHandler),this.$button[0].removeEventListener("click",this._buttonClickHandler),window.removeEventListener("keydown",this._globalKeyEventHandler)}},{key:"setButtonIcon",value:function(){this.$button.html('<span class="'+(this.open?"fa fa-caret-up":"fa fa-caret-down")+'"></span>')}},{key:"search",value:function(t){t||(t=""),this.selected=null;var e=void 0;return e=this.options.filter?this.options.filter(t,this.data):this.data,this.buildDropdownItems(e),e&&e.length&&t&&(this.options.distinct&&(e=this.getUniqueValuesOfKey(e,this.options.nameProperty)),1===e.length||this.options.selectFirstMatch?(this.autoSelect||this.options.selectFirstMatch)&&(this.selected=e[0],this.$input.val(e[0][this.options.nameProperty]),this.autoSelect=!1):this.autoSelect=!0),e}},{key:"getUniqueValuesOfKey",value:function(t,e){return t.reduce(function(t,i){return t.filter(function(t){return t[e]===i[e]}).length||t.push(i),t},[])}},{key:"buildDropdownItems",value:function(t){var e=this;if(t&&t.length){var i=this;this.destroyDropdownItems(),this.options.distinct&&(t=this.getUniqueValuesOfKey(t,this.options.nameProperty));for(var n=t.map(function(t){var n=document.createElement("li");return n.setAttribute("value",t[i.options.valueProperty]),n.innerHTML="<a>"+t[i.options.nameProperty]+"</a>",n.addEventListener("click",function(e){i.$input.val(t[i.options.nameProperty]),i.selected=t,i.open=!1}),e.options.preAppendDataItem&&e.options.preAppendDataItem(n,t),n}),s=0;s<n.length;s+=400)n.slice(s,s+400).forEach(function(t){return i.$items.append(t)})}}},{key:"destroyDropdownItems",value:function(){this.$items.children().remove()}},{key:"toggleOpen",value:function(){this.open=!this.open}},{key:"loadDataSource",value:function(){if(this.data=[],this.datasource=this.$input.data("source"),this.datasource||(this.datasource=this.options.dataSource),this.datasource)if("string"==typeof this.datasource){var t=this;requestBundler.get(this.datasource,function(e){t.data=e,t.selectInitialValue()})}else"object"===_typeof(this.datasource)&&(this.data=this.datasource,this.selectInitialValue())}},{key:"selectInitialValue",value:function(){this.$valueField&&(this.selected=this.$valueField.val(),this.$input.val(this.selected[this.options.nameProperty])),this.$input.trigger(this.options.initialValueSelectedEvent)}},{key:"setMenuDirection",value:function(){var t=this;requestAnimationFrame(function(){var e=t.$input.offset(),i=t.$input.outerHeight(),n=parseInt(t.$input.css("margin-top")),s=t.$items.outerHeight(),o=$(window).height(),a=e.top+i+s>o,r=e.top-$(window).scrollTop()-s>0;a&&r?t.$items.offset({top:e.top-s-n,left:e.left}):t.$items.offset({top:e.top+i+n,left:e.left})})}},{key:"open",get:function(){return!!this.$container.attr("open")},set:function(t){t?this.$container.attr("open",""):this.$container.removeAttr("open"),this.setButtonIcon(),this.open?(this.buildDropdownItems(this.data),this.$items.show(),this.setMenuDirection()):(this.$items.hide(),this.destroyDropdownItems())}},{key:"selected",get:function(){return this.$container.data("selected")},set:function(t){var e=this;if(t||(t={}),"object"!==(void 0===t?"undefined":_typeof(t))&&this.data){isNaN(+t)||(t=+t);var i=this.data.filter(function(i){return i[e.options.valueProperty]===t});i&&i.length&&i[0]&&(t=i[0])}this.$container[0].setAttribute("selected",t[this.options.valueProperty]||""),this.$container.data("selected",t),this.$input.removeClass(this.options.invalidClass),this.$valueField&&this.$valueField.val(t[this.options.valueProperty]||""),this.options.onSelected&&this.options.onSelected(this),this.$input.trigger("change")}}]),Autocomplete}(),defaultOptions={nameProperty:"name",valueProperty:"value",valueField:null,dataSource:null,filter:function(t,e){var i=this;return e.filter(function(e){return~e[i.options.nameProperty].toLowerCase().indexOf(t.toLowerCase())})},filterOn:"input",openOnInput:!0,preAppendDataItem:null,validation:null,selectFirstMatch:!1,validateOn:"blur",onSelected:null,invalidClass:"invalid",initialValueSelectedEvent:"initial-value-selected.autocomplete",appendToBody:!1,distinct:!1},requestBundler=new RequestBundler($.get);$.fn.autocomplete=function(t){return this.each(function(){var e=$(this),i=e.data("autocomplete"),n="object"===(void 0===t?"undefined":_typeof(t))&&t;if(i)i.reinitialize(n);else{var s=$.extend({},defaultOptions,n),o=new Autocomplete(this,s);e.data("autocomplete",o)}}),this},$(function(){$('[data-provide="softec-autocomplete"]').autocomplete()})}(window.jQuery);